openapi: 3.0.0
info:
  title: RealEstate API
  version: 1.0.0
  description: API for real estate management with authentication, authorization (JWT, roles), Zod validation, global error handling, and modules for users, properties, and units (landlord/admin CRUD with ownership).

servers:
  - url: http://localhost:3000/api/v1
    description: Local server

paths:

  /auth/registry:
    post:
      summary: Register a new user (Admin, Landlord, Tenant)
      description: >
        - Validates input with Zod (e.g., email format, password min 6 chars, role enum).  
        - TENANT & LANDLORD: registration allowed without token.  
        - ADMIN:  
          • If no admin exists → no token needed.  
          • If admin exists → must send Bearer token from an admin.  
        - Throws AppError for validation fails, handled globally.
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - email
                - password
                - role
              properties:
                name:
                  type: string
                  minLength: 1
                  description: Required, non-empty string.
                email:
                  type: string
                  format: email
                  description: Valid email format.
                password:
                  type: string
                  minLength: 6
                  description: At least 6 characters.
                role:
                  type: string
                  enum: [ADMIN, LANDLORD, TENANT]
                  description: Must be one of the allowed roles.
      responses:
        "201":
          description: User created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "user created successfully"
                  data:
                    type: object
                    properties:
                      name:
                        type: string
                      email:
                        type: string
                      role:
                        type: string
                      token:
                        type: string
        "401":
          description: Token required/expired/invalid for creating admin, or insufficient permissions.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "403":
          description: Only admins can create new admins.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "422":
          description: Validation failed (missing fields, invalid format, duplicate email) or invalid role.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppErrorWithDetails'
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'

  /auth/login:
    post:
      summary: Login user
      description: >
        - Validates input with Zod (email format, password min 6 chars).  
        - Returns JWT on success.  
        - Uses bcrypt for password compare, throws AppError for fails, handled globally.
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  description: Valid email format.
                password:
                  type: string
                  minLength: 6
                  description: At least 6 characters.
      responses:
        "200":
          description: Login success
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "user logged in successfully"
                  data:
                    type: object
                    properties:
                      id:
                        type: integer
                      email:
                        type: string
                      role:
                        type: string
                      token:
                        type: string
        "401":
          description: Wrong password or invalid credentials.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "422":
          description: Validation failed (missing fields, invalid format) or invalid email.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppErrorWithDetails'
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'

  /users:
    get:
      summary: List all users with search/filter (Admin only)
      description: >
        - Protected by JWT and admin role.  
        - Supports filters: role (exact), email (partial, case-insensitive).  
        - Returns safe fields (no password).  
        - Throws AppError for unauthorized, handled globally.
      tags:
        - Users
      security:
        - bearerAuth: []
      parameters:
        - name: role
          in: query
          schema:
            type: string
            enum: [ADMIN, LANDLORD, TENANT]
          description: Filter by exact role.
        - name: email
          in: query
          schema:
            type: string
          description: Partial email search (case-insensitive).
      responses:
        "200":
          description: List of users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
        "401":
          description: Unauthorized (missing/invalid token)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "403":
          description: Forbidden (non-admin role)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'

  /users/{id}:
    get:
      summary: Get user by ID (Admin only)
      description: >
        - Protected by JWT and admin role.  
        - Returns safe fields.  
        - Throws 404 if not found.
      tags:
        - Users
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: User ID
      responses:
        "200":
          description: User details
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    type: object
                    properties:
                      user:
                        $ref: '#/components/schemas/User'
        "400":
          description: Invalid ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'

    put:
      summary: Update user by ID (Admin only)
      description: >
        - Protected by JWT and admin role.  
        - Partial updates allowed (Zod validates optional fields).  
        - Hash password if provided.  
        - Throws 404 if not found, 422 for validation/duplicate.
      tags:
        - Users
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: User ID
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 1
                  description: Optional, non-empty string.
                email:
                  type: string
                  format: email
                  description: Optional, valid email.
                password:
                  type: string
                  minLength: 6
                  description: Optional, at least 6 characters (hashed if provided).
                role:
                  type: string
                  enum: [ADMIN, LANDLORD, TENANT]
                  description: Optional, valid role.
      responses:
        "200":
          description: User updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    $ref: '#/components/schemas/User'
        "400":
          description: Invalid ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "422":
          description: Validation failed or duplicate value
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppErrorWithDetails'
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'

    delete:
      summary: Delete user by ID (Admin only)
      description: >
        - Protected by JWT and admin role.  
        - Throws 404 if not found.
      tags:
        - Users
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: User ID
      responses:
        "200":
          description: User deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "User deleted successfully"
        "400":
          description: Invalid ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'

  /properties:
    post:
      summary: Create property (Landlord/Admin only)
      description: >
        - Protected by JWT.  
        - Validates with Zod (name/location/categoryId required).  
        - Auto-sets landlordId from token.  
        - Checks category exists.  
        - Throws 404 if category not found, 422 for validation.
      tags:
        - Properties
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - location
                - categoryId
              properties:
                name:
                  type: string
                  minLength: 1
                  description: Required, non-empty string.
                location:
                  type: string
                  minLength: 1
                  description: Required, non-empty string.
                categoryId:
                  type: integer
                  description: Required, positive integer (category ID).
                description:
                  type: string
                  description: Optional description.
      responses:
        "201":
          description: Property created
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    $ref: '#/components/schemas/Property'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "403":
          description: Forbidden (wrong role)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "404":
          description: Category not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "422":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppErrorWithDetails'
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'

    get:
      summary: List properties with filters (Landlord/Admin only)
      description: >
        - Protected by JWT.  
        - Filters: location (partial), categoryId (exact).  
        - Landlords see own; admins all.  
        - Includes category details.
      tags:
        - Properties
      security:
        - bearerAuth: []
      parameters:
        - name: location
          in: query
          schema:
            type: string
          description: Partial location search (case-insensitive).
        - name: categoryId
          in: query
          schema:
            type: integer
          description: Exact category ID filter.
      responses:
        "200":
          description: List of properties
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PropertyWithCategory'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'

  /properties/{id}:
    put:
      summary: Update property by ID (Landlord/Admin only)
      description: >
        - Protected by JWT.  
        - Partial updates (Zod validates).  
        - Landlords update own; admins all.  
        - Checks category if changed.  
        - Throws 403 if not owner, 404 if not found.
      tags:
        - Properties
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Property ID
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 1
                  description: Optional, non-empty string.
                location:
                  type: string
                  minLength: 1
                  description: Optional, non-empty string.
                categoryId:
                  type: integer
                  description: Optional, positive integer.
                description:
                  type: string
                  description: Optional description.
      responses:
        "200":
          description: Property updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    $ref: '#/components/schemas/Property'
        "400":
          description: Invalid ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "403":
          description: Forbidden (not owner or wrong role)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "404":
          description: Property or category not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "422":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppErrorWithDetails'
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'

    delete:
      summary: Delete property by ID (Landlord/Admin only)
      description: >
        - Protected by JWT.  
        - Landlords delete own; admins all.  
        - Checks for associated units.  
        - Throws 403 if not owner, 404 if not found, 400 if has units.
      tags:
        - Properties
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Property ID
      responses:
        "200":
          description: Property deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "Property deleted successfully"
        "400":
          description: Invalid ID or has associated units
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "403":
          description: Forbidden (not owner or wrong role)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "404":
          description: Property not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'

  /units:
    post:
      summary: Create unit (Landlord/Admin only)
      description: >
        - Protected by JWT.  
        - Validates with Zod (name/price/propertyId/status required).  
        - Checks property exists and ownership.  
        - Throws 404 if property not found, 403 if not owner, 422 for validation.
      tags:
        - Units
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - price
                - propertyId
                - status
              properties:
                name:
                  type: string
                  minLength: 1
                  description: Required, non-empty string.
                price:
                  type: number
                  description: Required, positive number.
                propertyId:
                  type: integer
                  description: Required, positive integer (property ID).
                status:
                  type: string
                  enum: [available, occupied]
                  description: Required status.
                size:
                  type: string
                  description: Optional size.
                description:
                  type: string
                  description: Optional description.
      responses:
        "201":
          description: Unit created
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    $ref: '#/components/schemas/Unit'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "403":
          description: Forbidden (not owner or wrong role)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "404":
          description: Property not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "422":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppErrorWithDetails'
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'

    get:
      summary: List units with filters (Landlord/Admin only)
      description: >
        - Protected by JWT.  
        - Filters: propertyId (exact), status (enum).  
        - Landlords see own; admins all.  
        - Includes property details.
      tags:
        - Units
      security:
        - bearerAuth: []
      parameters:
        - name: propertyId
          in: query
          schema:
            type: integer
          description: Exact property ID filter.
        - name: status
          in: query
          schema:
            type: string
            enum: [available, occupied]
          description: Status filter.
      responses:
        "200":
          description: List of units
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/UnitWithProperty'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'

  /units/{id}:
    put:
      summary: Update unit by ID (Landlord/Admin only)
      description: >
        - Protected by JWT.  
        - Partial updates (Zod validates).  
        - Landlords update own; admins all.  
        - Throws 403 if not owner, 404 if not found.
      tags:
        - Units
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Unit ID
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 1
                  description: Optional, non-empty string.
                price:
                  type: number
                  description: Optional, positive number.
                status:
                  type: string
                  enum: [available, occupied]
                  description: Optional status.
                size:
                  type: string
                  description: Optional size.
                description:
                  type: string
                  description: Optional description.
      responses:
        "200":
          description: Unit updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    $ref: '#/components/schemas/Unit'
        "400":
          description: Invalid ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "403":
          description: Forbidden (not owner or wrong role)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "404":
          description: Unit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "422":
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppErrorWithDetails'
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'

    delete:
      summary: Delete unit by ID (Landlord/Admin only)
      description: >
        - Protected by JWT.  
        - Landlords delete own; admins all.  
        - Checks if occupied.  
        - Throws 403 if not owner, 404 if not found, 400 if occupied.
      tags:
        - Units
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: Unit ID
      responses:
        "200":
          description: Unit deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "Unit deleted successfully"
        "400":
          description: Invalid ID or occupied unit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "403":
          description: Forbidden (not owner or wrong role)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "404":
          description: Unit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'
        "500":
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AppError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    AppError:
      type: object
      properties:
        status:
          type: string
          example: "fail"
        message:
          type: string
          example: "Invalid token"
    AppErrorWithDetails:
      type: object
      properties:
        status:
          type: string
          example: "fail"
        message:
          type: string
          example: "Validation failed"
        details:
          type: array
          items:
            type: string
          example: ["email: Invalid email format", "password: Password must be at least 6 characters long"]
    User:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        email:
          type: string
        role:
          type: string
          enum: [ADMIN, LANDLORD, TENANT]
    Property:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        location:
          type: string
        categoryId:
          type: integer
        description:
          type: string
        landlordId:
          type: integer
    PropertyWithCategory:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        location:
          type: string
        description:
          type: string
        landlordId:
          type: integer
        category:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
    Unit:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        price:
          type: number
        status:
          type: string
          enum: [available, occupied]
        size:
          type: string
        description:
          type: string
        propertyId:
          type: integer
    UnitWithProperty:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        price:
          type: number
        status:
          type: string
          enum: [available, occupied]
        size:
          type: string
        description:
          type: string
        propertyId:
          type: integer
        property:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
            location:
              type: string
            landlordId:
              type: integer